# Travel
Finds shortest route from airport A to airport B.

# Data

# SQL

CREATE ROLE travel_app LOGIN PASSWORD 'test' NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION;
CREATE ROLE travel LOGIN PASSWORD 'test' NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION;

CREATE DATABASE travel
  WITH OWNER=travel
  ENCODING = 'UTF8'
  TABLESPACE = pg_default
  CONNECTION LIMIT = -1;
  
CREATE SCHEMA travel;

GRANT CREATE ON DATABASE travel to travel;
GRANT TEMP ON DATABASE travel to travel;
GRANT TEMP ON DATABASE travel to travel_app;
GRANT CONNECT ON DATABASE travel to travel_app;
GRANT ALL ON TABLE airport_route to travel_app;
GRANT ALL ON TABLE airport to travel_app;


ALTER DATABASE travel SET SEARCH_PATH TO travel;
ALTER ROLE travel IN DATABASE travel SET SEARCH_PATH TO travel;
ALTER ROLE travel_app IN DATABASE travel SET SEARCH_PATH TO travel;

CREATE TABLE airport (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	iata VARCHAR(3),
	icao VARCHAR(4) NOT NULL,
	latitude DOUBLE PRECISION NOT NULL,
	longitude DOUBLE PRECISION NOT NULL
);

COMMENT ON COLUMN airport.id IS 'Airport ID	Unique OpenFlights identifier for this airport.';
COMMENT ON COLUMN airport.iata IS '3-letter IATA code. Null if not assigned/unknown.';
COMMENT ON COLUMN airport.icao IS '4-letter ICAO code.';
COMMENT ON COLUMN airport.latitude IS 'Latitude	Decimal degrees, usually to six significant digits. Negative is South, positive is North.';
COMMENT ON COLUMN airport.longitude IS 'Longitude	Decimal degrees, usually to six significant digits. Negative is West, positive is East.';

CREATE TABLE airport_route (
	source VARCHAR(4) NOT NULL,
	destination VARCHAR(4) NOT NULL
);

COMMENT ON COLUMN airport_route.source IS '3-letter (IATA) or 4-letter (ICAO) code of the source airport.';
COMMENT ON COLUMN airport_route.destination IS '3-letter (IATA) or 4-letter (ICAO) code of the destination airport.';

CREATE TABLE temp_airport (
	id VARCHAR,
	name VARCHAR,
	city VARCHAR,
	country VARCHAR,
	iata VARCHAR,
	icao VARCHAR,
	latitude VARCHAR,
	longitude VARCHAR,
	altitude VARCHAR,
	timezone VARCHAR,
	dst VARCHAR,
	tz_database_time_zone VARCHAR,
	type VARCHAR,
	source VARCHAR
);

COPY temp_airport (
	id,
	name,
	city,
	country,
	iata,
	icao,
	latitude,
	longitude,
	altitude,
	timezone,
	dst,
	tz_database_time_zone,
	type,
	source
) FROM 'airports.dat'
DELIMITER ','
CSV HEADER;

INSERT INTO airport
(
	iata,
	icao,
	latitude,
	longitude
) SELECT iata, icao, latitude::DOUBLE PRECISION, longitude::DOUBLE PRECISION FROM temp_airport;

DROP TABLE temp_airport;

UPDATE airport SET iata = NULL WHERE iata = '\N';

CREATE TABLE temp_airport_route (
	airline VARCHAR,
	airline_id VARCHAR,
	source VARCHAR,
	source_id VARCHAR,
	destination VARCHAR,
	destination_id VARCHAR,
	codeshare VARCHAR,
	stops VARCHAR,
	equipment VARCHAR
);

COPY temp_airport_route (
	airline,
	airline_id,
	source,
	source_id,
	destination,
	destination_id,
	codeshare,
	stops,
	equipment
) FROM 'routes.dat'
DELIMITER ','
CSV HEADER;

INSERT INTO airport_route
(
	source,
	destination
) SELECT source, destination FROM temp_airport_route;

DROP TABLE temp_airport_route;

SELECT * FROM airport_route LIMIT [100](100);

# Docker

Inside postgres_image:
1) `apt-get update`
2) `apt-get install wget, cmake, g++, libboost-graph-dev, git`
3) `wget -O pgrouting-3.1.3.tar.gz https://github.com/pgRouting/pgrouting/archive/v3.1.3.tar.gz`
4) `tar xvfz pgrouting-3.1.3.tar.gz`
5) `cd pgrouting-3.1.3`
```
mkdir build
cd build
cmake  ..
make
sudo make install
```

## Here
1) `apt-get install postgresql-11-pgrouting`

psql -h localhost
CREATE EXTENSION postgis;
CREATE EXTENSION pgrouting;
CREATE EXTENSION cube;
CREATE EXTENSION earthdistance;

Calculating distance

ALTER TABLE airport_route
ADD COLUMN distance INTEGER;

ALTER TABLE airport_route
ADD COLUMN source_id BIGINT;
ALTER TABLE airport_route
ADD COLUMN destination_id BIGINT;

UPDATE airport_route
SET source_id = (
SELECT id FROM airport WHERE airport.icao = airport_route.source OR airport.iata = airport_route.source
)
WHERE source_id IS NULL;

UPDATE airport_route
SET destination_id = (
SELECT id FROM airport WHERE airport.icao = airport_route.destination OR airport.iata = airport_route.destination
)
WHERE destination_id IS NULL;


ALTER TABLE airport_route
DROP COLUMN destination_id;
ALTER TABLE airport_route
DROP COLUMN source_id;

ALTER TABLE airport_route
ADD COLUMN id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL;


UPDATE airport_route
SET distance = (
	SELECT
		point(source_airport.longitude, source_airport.latitude)
		<@>
		point(destination_airport.longitude, destination_airport.latitude)
	FROM
		airport AS source_airport,
		airport AS destination_airport
	WHERE
		airport_route.source IN (source_airport.iata, source_airport.icao) AND
		airport_route.destination IN (destination_airport.iata, destination_airport.icao)
)::NUMERIC * 1.609344 WHERE TRUE;

select * from airport_route limit 100;

## Miles
select (point(-0.1277,51.5073) <@> point(-74.006,40.7144)) as distance;
## Kilometers
select  ROUND( ('(33.0, 97.1)'::point <@> '(24.0, 88.6)')::NUMERIC * 1.609344 ) as km;

WHERE destination IS NULL;


select * from airport limit 2;

SELECT *
FROM airport AS source_airport,
airport AS destination_airport
WHERE source_airport.iata = 'MAG' AND destination_airport.iata = 'HGU';

SELECT COUNT(*) FROM airport_route;
SELECT * FROM airport_route WHERE distance IS NULL LIMIT 100;
SELECT * FROM airport WHERE iata = 'ADQ' OR icao = 'ADQ';
SELECT * FROM airport_route WHERE distance > 10000;
DELETE FROM airport_route WHERE distance IS NULL;

## UPDATE INSERT INTO reading from temp table.
SELECT * FROM airport_route LIMIT 100;


// TODO edges should be maximum length 4, so i should
find all the maximum 4 edges that are needed to achive this
SELECT * FROM pgr_dijkstra(
	'SELECT
		airport_route.id AS id,
		source_airport.id AS source,
		destination_airport.id AS target,
		airport_route.distance AS cost
	FROM
		airport_route
	LEFT JOIN airport AS source_airport
		ON source_airport.iata = airport_route.source
		OR source_airport.icao = airport_route.source
	LEFT JOIN airport AS destination_airport
		ON destination_airport.iata = airport_route.destination
		OR destination_airport.icao = airport_route.destination', 2, 3, TRUE);

SELECT * FROM airport LIMIT 100;


SELECT
		airport_route.id,
		source_airport.id,
		destination_airport.id,
		airport_route.distance
	FROM
		airport_route
	LEFT JOIN airport AS source_airport
		ON source_airport.iata = airport_route.source
		OR source_airport.icao = airport_route.source
	LEFT JOIN airport AS destination_airport
		ON destination_airport.iata = airport_route.destination
		OR destination_airport.icao = airport_route.destination LIMIT 100;
		
		
SELECT * FROM pgr_dijkstra(
	'SELECT
		airport_route.id AS id,
		airport_route.source_id AS source,
		airport_route.destination_id AS target,
		airport_route.distance AS cost
	FROM
		airport_route', 1, 20, TRUE);
		
		
SELECT * FROM pgr_dijkstraCostMatrix(
   'SELECT
		airport_route.id AS id,
		airport_route.source_id AS source,
		airport_route.destination_id AS target,
		airport_route.distance AS cost
	FROM
		airport_route',
    5)
);


SELECT * FROM pgr_KSP(
	'SELECT
		airport_route.id AS id,
		airport_route.source_id AS source,
		airport_route.destination_id AS target,
		airport_route.distance AS cost
	FROM
		airport_route', 1, 20, 100, TRUE, TRUE);
		
		
SELECT * FROM pgr_breadthFirstSearch(
	'SELECT
		airport_route.id AS id,
		airport_route.source_id AS source,
		airport_route.destination_id AS target,
		airport_route.distance AS cost
	FROM
		airport_route', 1, 3, TRUE);
		
SELECT node FROM pgr_kruskalBFS(
	'SELECT
		airport_route.id AS id,
		airport_route.source_id AS source,
		airport_route.destination_id AS target,
		airport_route.distance AS cost
	FROM
		airport_route', 1, 3);

// TODO destination should be added to the IN condition
SELECT * FROM pgr_dijkstra(
	'SELECT
		airport_route.id AS id,
		airport_route.source_id AS source,
		airport_route.destination_id AS target,
		airport_route.distance AS cost
	FROM
		airport_route
	WHERE 
	airport_route.destination_id IN (
   1,
   2,
   3,
   5,
4142,
   4,
4148,
4143,
4146,
4145,
4133,
4136,
4135,
4147,
4140,
3128,
7348,
4134,
4137,
4131,
3971,
4132,
3130,
3734,
3853,
2915,
4141,
2289,
1894,
2181,
3124,
3167,
20,
4149
	)
	OR
	airport_route.source_id IN (
	20,
   1,
   2,
   3,
   5,
4142,
   4,
4148,
4143,
4146,
4145,
4133,
4136,
4135,
4147,
4140,
3128,
7348,
4134,
4137,
4131,
3971,
4132,
3130,
3734,
3853,
2915,
4141,
2289,
1894,
2181,
3124,
3167,
4149
	)', 1, 20, TRUE);
	
SELECT * FROM pgr_dijkstra(
	'SELECT
		airport_route.id AS id,
		airport_route.source_id AS source,
		airport_route.destination_id AS target,
		airport_route.distance AS cost
	FROM
		airport_route', 1, 20, TRUE);
		
SELECT * FROM airport WHERE iata IN ('TLL');
SELECT * FROM airport WHERE iata IN ('RIX');
SELECT * FROM airport WHERE iata IN ('HEL'); //417
SELECT * FROM airport WHERE iata IN ('FKB'); // 3935
SELECT * FROM airport WHERE id = 347;
